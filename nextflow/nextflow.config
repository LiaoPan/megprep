// nextflow.config

// ------------------------------
// Global Parameters Configuration
// ------------------------------
params {
    dataset_dir = "/data/liaopan/datasets/SMN4Lang_single2"
    preproc_dir = "/data/liaopan/datasets/SMN4Lang_single2/preprocessed"          // Output results directory
    output_dir = "/data/liaopan/datasets/SMN4Lang_single2/g2" // nextflow logs directory

    code_dir = "/data/liaopan/megprep/megprep"   // all codes for preprocessing.

    max_cpus = 20                         // Total number of CPU cores available
    max_memory = "100 GB"                 // Total memory available

    do_fs = false // false
    is_bids = true  // Whether the data is in BIDS format
    anatomy_preprocess_method = "freesurfer" // "freesurfer" or "deepprep"

    //freesurfer method
    t1_dir = dataset_dir // "/data/liaopan/datasets/Holmes_cn/T1" // dataset_dir      // T1 image directory
    t1_input_type = "nifti"                      // 'dicom' or 'nifti'

    fs_subjects_dir = "/data/liaopan/datasets/fake_smn4lang_single2_smri"
    //fs_subjects_dir = "/data/liaopan/datasets/Holmes_cn/Holmes_cn_smri"
    freesurfer_home = "/data/liaopan/toolbox/freesurfer/7.4.1-1"

    //deepprep method
    deepprep_device = "cpu"
    t1_bids_dir = "/data/liaopan/datasets/Holmes_cn/T1_bids/"
    fs_license = "/data/liaopan/megprep/megprep/tools/DeepPrep/license.txt"
    //fs_subjects_dir = "/data/liaopan/datasets/Holmes_cn/smri_deep2"

    // BEM model parameters
    bem_config = """
        ico: 4
        conductivity:
            - 0.3
    """
    //ico = 4
    //conductivity = [0.3]

    // MEG import datasets
    dataset_format = 'auto'       // 'auto','bids' or 'raw'
    file_suffix = '.fif'          //  only for raw datasets


    // MEG Artifacts Detection Parameters
    artifact_config = """
        - bad_segments: {segment_len: 500, picks: mag, significance_level: 0.1}
        - bad_segments: {segment_len: 500, picks: mag, mode: diff, significance_level: 0.1}
    """

    meg_type = "grad" // 或者 "mag"
    segment_len = 1000

    bad_channels_pyprep = ["deviation", "snr"] // pyprep 的方法
    bad_channels_psd = true
    bad_channels_osl = true

    // MEG Preprocessing Parameters
    preproc_config = """
        preproc:

        - filter: {l_freq: 0.5, h_freq: 125, method: iir, iir_params: {order: 5, ftype: butter}}
        - notch_filter: {freqs: 50 100}
        - resample: {sfreq: 250}
    """

    // MEG ICA Parameters
    num_IC = 60 // 0.99999
    ICA_output_dir = "ica_report" // relative path based on preproc dir

    // MEG Epochs Parameters
    epoch_output_dir = "epochs" // relative path based on preproc dir
    epoch_config = """
    task_type: 'task'   # or 'resting'
    resting:
        fixed_length_duration: 2.0

    event_source: 'find_events'  # or 'find_events'

    # find events
    find_events:
        stim_channel: null
        shortest_event: 1
        min_duration: 0.0
    epochs:
        event_id: null

        tmin: -0.2
        tmax: 1
        reject_by_annotation: true
        picks: meg
        baseline: null
        reject:
            grad: 4000e-13
            mag: 4e-12
        preload: true
        detrend: null
        reject_by_annotation: true
    """


    // MEG-MRI coregistraion Parameters
    trans_output_dir = "trans"
    core_config = """
    omit_head_shape_points: 1 # mm
    grow_hair: 0.0 #mm
    icp:
        n_iterations: 200
        lpa_weight: 1.0
        nasion_weight: 10.0
        rpa_weight: 1.0
        hsp_weight: 10.0
        eeg_weight: 0.0
        hpi_weight: 1.0
    finetune_icp:
        n_iterations: 200
        lpa_weight: 0.0
        nasion_weight: 0.0
        rpa_weight: 0.0
        hsp_weight: 10.0
        eeg_weight: 0.0
        hpi_weight: 0.0
    """

    // Covariance Parameters
    covar_output_dir = "covariance"
    covar_config = """
        # find events
        events:
            stim_channel: null
            shortest_event: 1
            min_duration: 0.0

        # For baseline epochs
        epochs:
            event_id: null # baseline event id
            tmin: -0.2 # Start time (in seconds) for covariance calculation window
            tmax: 0.0 # End time (in seconds) for covariance calculation window
            reject_by_annotation: true
            picks: meg
            baseline: null
            reject:
                grad: 4000e-13
                mag: 4e-12
            preload: true
            detrend: null
            reject_by_annotation: true

        covariance:
            tmin: null  #Start time for baseline. If null start at first sample.
            tmax: null  # End time for baseline. If null end at last sample.
            rank: null  # Rank used for covariance calculation| meg: 90
    """


    // Forward Solution Parameters
    fwd_output_dir = "forward_solution"
    fwd_epoch_label = "wdonset"
    fwd_config = """
        surface: white # pial
        spacing: ico4
    """

    // Source Imaging Parameters
    src_output_dir = "source_recon"
    src_config = """
        source_methods:
            - dSPM

        data_type: meg  # mag
        spacing: ico4
        epoch_label: wdonset

        dSPM:
            inverse_operator:
                loose: auto
                depth: 0.8
                fixed: auto
                rank:
                    meg : 50
            apply_inverse:
                ##lambda2: 0.1111111111
                method: dSPM
                pick_ori: normal

        LCMV:
            cov_tmin: 0.01
            cov_tmax: 0.4
            make_lcmv:
                reg: 0.05
                pick_ori: null
                rank:
                    meg : 50
                weight_norm: unit-noise-gain-invariant
"""

}

// ------------------------------
// Common Configuration
// ------------------------------

// Define the working directory for Nextflow
workDir = "${params.output_dir}/work"

// Logging configuration
log {
    file = "${params.preproc_dir}/logs/nextflow.log" // Path to the Nextflow log file
    level = 'INFO'                                  // Logging level: TRACE, DEBUG, INFO, WARN, ERROR
}


report {
    overwrite = true
}

timeline {
    overwrite = true
}

// Error handling strategy
errorStrategy = 'retry' // Options: 'ignore', 'retry', 'finish', 'terminate'
retry {
    maxRetries = 1         // Maximum number of retry attempts 3
    delay = '10 sec'       // Delay between retries
    maxDelay = '5 min'     // Maximum delay between retries
}

// Default resource allocation for processes (can be overridden by profiles)
process {
    cpus = 2                      // Default CPU cores per task
    memory = '8 GB'               // Default memory per task
}

